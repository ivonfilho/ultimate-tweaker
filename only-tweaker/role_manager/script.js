!function(e){var a=e(window),t=function(){var e=Array.prototype.slice.call(arguments);return e.shift().replace(/%s/g,function(){return e.shift()})},i=function(){var e=this;e.inited=!1};i.prototype={init:function(){var a=this,t=e("body");a.inited||(a.inited=!0,a.close=e.proxy(a.close,a),a.createRole=e.proxy(a.createRole,a),a.$list=e('<div class="ut_role_manager_dialog_list"></div>'),a.$form=e('<div class="ut_role_manager_dialog_form"></div>'),a.$dialog=e('<div id="ut_role_manager_dialog_body"></div>'),a.$dialog.append(a.$list),a.$dialog.append(a.$form),t.append(a.$dialog))},show:function(){var t=this;t.init(),t.$dialog.dialog({modal:!0,create:function(a,t){e(a.target).parent().css("position","fixed")},resizeStop:function(i,o){var r=[Math.floor(o.position.left)-a.scrollLeft(),Math.floor(o.position.top)-a.scrollTop()];e(i.target).parent().css("position","fixed"),t.$dialog.dialog("option","position",r)},dialogClass:"ut_jquery_ui_dialog ut_role_manager_dialog",title:roleManagerConfig.title,closeOnEscape:!0,minHeight:"600",height:.9*e(window).height(),width:"800",autoOpen:!0,buttons:[{text:roleManagerConfig.cancel,click:t.close},{text:roleManagerConfig.save,class:"ut_button_primary",click:function(){t.saveData(t.close)}}]}).on("dialogclose",function(){t.$list.empty(),t.$form.empty(),t.$createRoleForm&&t.$createRoleForm.dialog("close")}),t.loadData()},close:function(){var e=this;e.$dialog.dialog("close")},setLoading:function(a,t){var i=this;t=t||roleManagerConfig.loading,i.$loading||(i.$loadingWrap=e("<div/>"),i.$loading=e("<div/>",{class:"ut_role_manager_dialog_loading"}),i.$loading.append(i.$loadingWrap),e(".ut_role_manager_dialog").append(i.$loading)),a?(i.$loadingWrap.html(t),i.$loading.css("top",e(".ut_role_manager_dialog .ui-dialog-titlebar").outerHeight()),i.$loading.fadeIn("fast")):i.$loading.fadeOut("fast")},loadData:function(){var a=this;a.data=null,a.setLoading(!0),e.post(ajaxurl,{action:"ot_rm_get"+(APP.is_network_admin?"-network":""),_wpnonce:roleManagerConfig.nonce},function(t){return t<=0?void console.log(t):(a.data=t.roles,e.each(a.data,function(t,i){i.hasOwnProperty("capabilities")&&i.capabilities&&e.isPlainObject(i.capabilities)||(a.data[t].capabilities={})}),a.deprecated_capabilities=t.deprecated_capabilities,a.outputData(),void a.setLoading(!1))})},saveData:function(a){var t=this;t.setLoading(!0,roleManagerConfig.saving),e.post(ajaxurl,{action:"ot_rm_save"+(APP.is_network_admin?"-network":""),data:t.data,_wpnonce:roleManagerConfig.nonce},function(e){return e<=0?void alert("Error."):(t.data=null,a(),void t.setLoading(!1))})},outputData:function(){var a=this,i=a.data;a.$list.empty(),a.$form.empty();var o=e("<ul/>");e.each(i,function(a,t){if(!t.isDeleted){var i=e('<li data-role-id="'+a+'" title="'+a+'">'+t.name+"</li>");"administrator"!=a&&i.append(e('<div data-action="delete" class="dashicons dashicons-trash"></li>')),i.append(e('<div data-action="rename" class="dashicons dashicons-edit"></li>')),o.append(i)}}),o.append("<hr/>");var r=e('<li data-action="create-role">'+roleManagerConfig.createRole+"</li>");r.click(a.createRole),o.append(r),a.$list.append(o),o.on("click","[data-role-id]",function(){var t=e(this),i=t.data("roleId");o.find("li").not(t).removeClass("selected"),t.addClass("selected"),a.outputForm(i)}),a.$list.off("click.ut_role_actions").on("click.ut_role_actions","[data-action]",function(o){o.preventDefault(),o.stopPropagation();var r=e(this),n=r.parents("[data-role-id]"),l=n.data("roleId"),s=r.data("action");if("rename"==s){var d=function(i,o){var r=prompt(roleManagerConfig.newRoleNameConfirmation,i);if(r){if(r.length>32||r.length<3)return alert(t(roleManagerConfig.form_checkLengthMessage,roleManagerConfig.form_Name,3,32)),void d(r,o);e.each(a.data,function(e,a){if(a.name==r)return alert(roleManagerConfig.form_checkRoleNameExistsMessage),void d(r,o)}),o(r)}};d(i[l].name,function(e){a.data[l].name=e,a.outputData()})}else"delete"==s&&confirm(roleManagerConfig.deleteConfirmation)&&(a.data[l].isDeleted=!0,a.outputData())}),o.find("li:first").click()},outputForm:function(a){var t=this,i=t.data,o=i[a].capabilities,r=t.readAllCapabilities();t.$form.empty();var n=e('<div class="ut_role_manager_dialog_body_wrap"/>');e.each(r,function(t,i){var r=i.name,l=i.caps,s=e("<div/>",{class:"ut_rm_group"}),d=e("<div/>",{class:"ut_rm_group_body"}),c=e("<h3/>",{html:r});c.append(e("<a/>",{class:"ut_rm_group_checkall",html:"Check all"})),c.append(e("<span/>",{html:"/"})),c.append(e("<a/>",{class:"ut_rm_group_uncheckall",html:"Uncheck all"})),s.append(c).append(d),e.each(l,function(t,i){var r=!1;"administrator"==a&&(r=!0),"manage_options"!=t||"administrator"!=a&&"ut_administrator"!=a||(r=!0);var n=e("<label/>",{for:"capability-"+t}),l=e("<input/>",{id:"capability-"+t,name:t,type:"checkbox",disabled:r,checked:o[t]});n.append(l).append(i),d.append(n)}),n.append(s)}),t.$form.append(n),t.$form.off("change.checkbox").on("change.checkbox","input[type=checkbox]",function(){var a=e(this),i=t.$list.find("li.selected").data("roleId");t.data[i].capabilities&&!e.isArray(t.data[i].capabilities)||(t.data[i].capabilities={}),t.data[i].capabilities[a.prop("name")]=!!a.prop("checked")}),t.$form.off("click.uncheck").on("click.uncheck",".ut_rm_group_uncheckall",function(a){a.preventDefault();var t=e(this).parents(".ut_rm_group").find("input[type=checkbox]").not("[disabled]");t.prop("checked",!1).trigger("change")}),t.$form.off("click.check").on("click.check",".ut_rm_group_checkall",function(a){a.preventDefault();var t=e(this).parents(".ut_rm_group").find("input[type=checkbox]").not("[disabled]");t.prop("checked",!0).trigger("change")})},readAllCapabilities:function(){var a=this,t=a.data,i=[],o=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},r={};r.Dashboard=["read","edit_dashboard"],r.Posts=["publish_posts","edit_posts","delete_posts","edit_published_posts","delete_published_posts","edit_others_posts","delete_others_posts","read_private_posts","edit_private_posts","delete_private_posts","manage_categories"],r.Media=["upload_files","unfiltered_upload"],r.Pages=["publish_pages","edit_pages","delete_pages","edit_published_pages","delete_published_pages","edit_others_pages","delete_others_pages","read_private_pages","edit_private_pages","delete_private_pages"],r.Comments=["edit_comment","moderate_comments"],r.Themes=["switch_themes","edit_theme_options","edit_themes","delete_themes","install_themes","update_themes"],r.Plugins=["activate_plugins","edit_plugins","install_plugins","update_plugins","delete_plugins"],r.Users=["list_users","create_users","edit_users","delete_users","promote_users","add_users","remove_users"],r.Tools=["import","export"],r.Admin=["manage_options","update_core","unfiltered_html"],r.Links=["manage_links"];var n=[];e.each(r,function(a,t){var r={};e.each(t,function(e,a){i.push(a);var t=o(a.replace(/_/g," "));r[a]=t}),n.push({name:a,caps:r})});var l="Other Capabilities",s={};return e.each(t,function(t,r){e.each(r.capabilities,function(e){if(!(i.indexOf(e)>=0||a.deprecated_capabilities.hasOwnProperty(e)||s[e])){var t=o(e.replace(/_/g," "));s[e]=t}})}),n.push({name:l,caps:s}),n},createRole:function(a){var i=this;a.preventDefault(),i.$createRoleForm&&i.$createRoleForm.dialog("close"),i.$createRoleForm=e('<div id="ut_rm_create_role_form"><p class="validateTips">'+roleManagerConfig.form_allRequired+'</p><form><fieldset><label for="ut_cr_id">'+roleManagerConfig.form_ID+'</label><input type="text" name="id" id="ut_cr_id" value="" class=""><label for="ut_cr_name">'+roleManagerConfig.form_Name+'</label><input type="text" name="name" id="ut_cr_name" value="" class=""></fieldset></form></div>'),e("body").append(i.$createRoleForm);var o=function(e,a,i,o){return!(e.val().length>o||e.val().length<i)||(e.addClass("ui-state-error"),n(t(roleManagerConfig.form_checkLengthMessage,a,i,o)),!1)},r=function(e,a,t){return!!a.test(e.val())||(e.addClass("ui-state-error"),n(t),!1)},n=function(e){var a=i.$createRoleForm.find(".validateTips");a.text(e).addClass("ui-state-highlight"),setTimeout(function(){a.removeClass("ui-state-highlight",1500)},500)},l=function(){var a=!0,t=i.$createRoleForm.find("[name=id]"),l=i.$createRoleForm.find("[name=name]"),s=e([]).add(t).add(l);if(s.removeClass("ui-state-error"),a=a&&o(t,roleManagerConfig.form_ID,3,16),a=a&&r(t,/^[a-z]([0-9a-z_])+$/i,roleManagerConfig.form_checkRoleIDRegExpMessage),a=a&&o(l,roleManagerConfig.form_Name,3,32),a&&i.data.hasOwnProperty(t.val())&&(t.addClass("ui-state-error"),n(roleManagerConfig.form_checkRoleIDExistsMessage),a=!1),a){var d=l.val();e.each(i.data,function(e,t){t.name==d&&(l.addClass("ui-state-error"),n(roleManagerConfig.form_checkRoleNameExistsMessage),a=!1)})}if(a){var c=l.val();i.data[t.val()]={name:c.charAt(0).toUpperCase()+c.substr(1),capabilities:{},isCreated:!0},i.$createRoleForm.dialog("close"),i.outputData()}};i.$createRoleForm.dialog({dialogClass:"ut_jquery_ui_dialog",modal:!0,closeOnEscape:!0,minWidth:350,title:roleManagerConfig.createRoleTitle,buttons:[{text:roleManagerConfig.cancel,click:function(){i.$createRoleForm.dialog("close")}},{text:roleManagerConfig.create,class:"ut_button_primary",click:l}],close:function(){i.$createRoleForm.remove(),i.$createRoleForm=null}})}};var o=new i;e(function(){e(".ut_role_manager_a").click(function(e){e.preventDefault(),o.show()})})}(jQuery);